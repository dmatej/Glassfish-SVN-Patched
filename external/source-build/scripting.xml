<?xml version="1.0" encoding="iso-8859-1"?>

<project name="Scripting source integration" default="build" basedir=".">

    <!-- jruby dependencies -->
    <property name="jcondings.version" value="1.0.1"/>
    <property name="asm.version" value="3.1"/>
    <property name="bytelist.version" value="1.0.3"/>
    <property name="jline.version" value="0.9.93"/>
    <property name="joda-time.version" value="1.5.1"/>
    <property name="joni.version" value="1.1.3"/>
    <property name="jvyamlb.version" value="0.2.5"/>
    <property name="jna.version" value="3.0.9"/>
    <property name="jna-posix.version" value="1.0.1"/>
    <property name="constantine.version" value="0.6"/>
    <property name="jaffi.version" value="0.4.1"/>
    <property name="jruby.version" value="1.3.1"/>

    <!-- jruby container dependencies versions -->
    <property name="jruby-monitor.version" value="1.5.5"/>
    <property name="jruby-config.version" value="1.5.0"/>
    <property name="jruby-commons.version" value="1.3"/>
    <property name="grizzly-jruby.version" value="1.8.20"/>
    <property name="grizzly-scripting-common.version" value="1.2"/>
    <property name="jruby-container.version" value="1.0-b10"/>

    <!-- import build.xml for init target and inherited properties -->
    <import file="build.xml"/>

    <!-- Macros -->

    <macrodef name="hgco">
        <attribute name="version" default="tip"/>
        <attribute name="url"/>
        <attribute name="name"/>
        <sequential>
            <echo message="checkout @{name} from @{url}."/>
            <exec executable="hg" dir="${external.dir}" failonerror="true">
                <arg line="clone"/>
                <arg line="-r @{version}"/>
                <arg line="@{url}"/>
                <arg line="@{name}"/>
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="gitco">
        <attribute name="url"/>
        <attribute name="name"/>
        <sequential>
            <echo message="checkout @{name} from @{url}."/>
            <exec executable="git" dir="${external.dir}" failonerror="true">
                <arg line="clone"/>
                <arg line="@{url}"/>
                <arg line="@{name}"/>
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="gitswitch" description="Switches the git repo to specified tag version">
        <attribute name="dir"/>
        <attribute name="name"/>
        <attribute name="version"/>
        <sequential>
            <echo message="Switching @{name} to @{version}."/>
            <exec executable="git" dir="@{dir}" failonerror="true">
                <arg line="checkout"/>
                <arg line="@{version}"/>
            </exec>
        </sequential>
    </macrodef>


    <macrodef name="mvnbuild">
        <attribute name="dir"/>
        <attribute name="name"/>
        <sequential>
            <echo message="Building @{name}."/>
            <exec executable="mvn" dir="@{dir}" failonerror="true">
                <arg line="-Dmaven.repo.local=${maven.repo.local}"/>
                <arg line="clean install"/>
                <arg line="-Dmaven.test.skip=true"/>
            </exec>
        </sequential>
    </macrodef>


    <target name="build" depends="init">
        <antcall target="scripting.build"/>
    </target>


    <target name="scripting.build" depends="jruby.build">

        <!-- grizzly-scripting-common -->
        <svnco  name="grizzly-scripting-common-${grizzly-scripting-common.version}" url="https://svn.dev.java.net/svn/glassfish-scripting/tags/grizzly-scripting-common-${grizzly-scripting-common.version}"/>
        <mvnbuild name="grizzly-scripting-common-${grizzly-scripting-common.version}" dir="${external.dir}/grizzly-scripting-common-${grizzly-scripting-common.version}"/>

        <!-- jruby commons -->
        <svnco  name="jruby-commons-${jruby-commons.version}" url="https://svn.dev.java.net/svn/glassfish-scripting/tags/jruby-commons-${jruby-commons.version}"/>
        <mvnbuild name="jruby-commons-${jruby-commons.version}" dir="${external.dir}/jruby-commons-${jruby-commons.version}"/>

        <!-- jruby monitoring -->
        <svnco  name="jruby-monitoring-${jruby-monitor.version}" url="https://svn.dev.java.net/svn/glassfish-scripting/tags/jruby-monitor-${jruby-monitor.version}"/>
        <mvnbuild name="jruby-monitoring-${jruby-monitor.version}" dir="${external.dir}/jruby-monitoring-${jruby-monitor.version}"/>

        <!-- jruby config -->
        <svnco  name="jruby-config-${jruby-config.version}" url="https://svn.dev.java.net/svn/glassfish-scripting/tags/jruby-config-${jruby-config.version}"/>
        <mvnbuild name="jruby-config-${jruby-config.version}" dir="${external.dir}/jruby-config-${jruby-config.version}"/>

        <!-- grizzly-jruby -->
        <svnco  name="grizzly-jruby-${grizzly-jruby.version}" url="https://svn.dev.java.net/svn/glassfish-scripting/tags/grizzly-jruby-${grizzly-jruby.version}"/>
        <mvnbuild name="grizzly-jruby-${grizzly-jruby.version}" dir="${external.dir}/grizzly-jruby-${grizzly-jruby.version}"/>

        <!-- jruby-container -->
        <svnco name="jruby-container-${jruby-container.version}" url="https://svn.dev.java.net/svn/glassfish-scripting/tags/rails-${jruby-container.version}"/>
        <mvnbuild name="jruby-container-${jruby-container.version}" dir="${external.dir}/jruby-container-${jruby-container.version}"/>
    </target>


    <!-- jruby-complete -->
    <target name="jruby.build">
        <antcall target="jcodings.build"/>
        <asm.build version="${asm.version}"/>
        <antcall target="bytelist.build"/>
        <antcall target="jline.build"/>
        <antcall target="joda-time.build"/>
        <antcall target="joni.build"/>
        <antcall target="jvyamlb.build"/>
        <antcall target="jna.build"/>
        <antcall target="jna-posix.build"/>
        <antcall target="constantine.build"/>
        <antcall target="jaffi.build"/>

        <!-- now that all jruby dependencies are built, time to build jruby itself -->
        <gitco name="jruby-${jruby.version}" url="git://kenai.com/jruby~main"/>
        <gitswitch name="jruby-${jruby.version}" version="${jruby.version}" dir="${external.dir}/jruby-${jruby.version}/maven/jruby-complete"/>
        <replace file="${external.dir}/jruby-${jruby.version}/pom.xml">
          <replacetoken><![CDATA[<dependency>
      <groupId>bsf</groupId>
      <artifactId>bsf</artifactId>
      <version>2.3.0</version>
      <scope>provided</scope>
    </dependency>]]></replacetoken>
          <replacevalue></replacevalue>
        </replace>

        <mvnbuild name="jruby-${jruby.version}" dir="${external.dir}/jruby-${jruby.version}/maven/jruby-complete"/>
    </target>


    <!-- jline -->
    <target name="jline.build">
        <svnco url="https://glassfish-svn.dev.java.net/svn/glassfish-svn/trunk/external/modules/jline/${jline.version}"
               name="jline-${jline.version}"/>
        <mvnbuild dir="${external.dir}/jline-${jline.version}" name="jline-${jline.version}"/>
    </target>

    <!-- joda-time -->
    <target name="joda-time.build">
        <svnco url="https://glassfish-svn.dev.java.net/svn/glassfish-svn/trunk/external/modules/joda-time/${joda-time.version}" name="joda-time-${joda-time.version}"/>
        <property name="junit.ant" value="true"/>
        <ant dir="${external.dir}/joda-time-${joda-time.version}/" antfile="build.xml" target="jar"/>
        <mvn-local-install artifactid="joda-time" groupid="joda-time" version="${joda-time.version}" pomfile="pom-release.xml"
                           dir="${external.dir}/joda-time-${joda-time.version}" file="build/joda-time-${joda-time.version}.jar"/>
    </target>

    <!-- bytelist -->
    <target name="bytelist.build">
        <svnco url="https://glassfish-svn.dev.java.net/svn/glassfish-svn/trunk/external/modules/bytelist/${bytelist.version}"
               name="bytelist-${bytelist.version}"/>
        <mvnbuild dir="${external.dir}/bytelist-${bytelist.version}" name="bytelist-${bytelist.version}"/>
    </target>

    <!-- jcodings -->
    <target name="jcodings.build">
        <svnco url="https://glassfish-svn.dev.java.net/svn/glassfish-svn/trunk/external/modules/jcodings/${jcondings.version}"
               name="jcodings-${jcondings.version}"/>
        <mvnbuild dir="${external.dir}/jcodings-${jcondings.version}" name="jcodings-${jcondings.version}"/>
    </target>

    <!-- joni -->
    <target name="joni.build">
        <svnco url="https://glassfish-svn.dev.java.net/svn/glassfish-svn/trunk/external/modules/joni/${joni.version}"
               name="joni-${joni.version}"/>
        <mvnbuild dir="${external.dir}/joni-${joni.version}" name="joni-${joni.version}"/>
    </target>


    <!-- jvyamlb -->
    <target name="jvyamlb.build">
        <svnco url="https://glassfish-svn.dev.java.net/svn/glassfish-svn/trunk/external/modules/jvyamlb/${jvyamlb.version}"
               name="jvyamlb-${jvyamlb.version}"/>
        <mvnbuild dir="${external.dir}/jvyamlb-${jvyamlb.version}" name="jvyamlb-${jvyamlb.version}"/>
    </target>

    <!-- jna -->
    <target name="jna.build">
        <svnco url="https://jna.dev.java.net/svn/jna/tags/${jna.version}/jnalib" name="jna-${jna.version}"/>
        <mvnbuild dir="${external.dir}/jna-${jna.version}" name="jna-${jna.version}"/>
    </target>

    <!-- jna-posix -->
    <target name="jna-posix.build">
        <hgco name="jna-posix-${jna-posix.version}" url="https://hg.kenai.com/hg/jna-posix~mercurial" version="${jna-posix.version}"/>
        <mvnbuild dir="${external.dir}/jna-posix-${jna-posix.version}" name="jna-posix-${jna-posix.version}"/>
    </target>

    <!-- constantine -->
    <target name="constantine.build">
        <!-- there is no tag for 0.6, the tip appears to be 0.6 -->
        <hgco name="constantine-${constantine.version}" url="https://hg.kenai.com/hg/constantine~mercurial"/>
        <mvnbuild dir="${external.dir}/constantine-${constantine.version}" name="constantine-${constantine.version}"/>
    </target>

    <!-- jaffi -->
    <target name="jaffi.build">
        <hgco name="jaffi-${jaffi.version}" url="https://hg.kenai.com/hg/jffi~core" version="${jaffi.version}"/>
        <mvnbuild dir="${external.dir}/jaffi-${jaffi.version}" name="jaffi-${jaffi.version}"/>
    </target>

</project>
