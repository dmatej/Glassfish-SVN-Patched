<?xml version="1.0" encoding="iso-8859-1"?>

<project name="Jersey source integration" default="build" basedir=".">

    <!-- import build.xml for init target and inherited properties -->
    <import file="build.xml"/>

    <target name="build" depends="init">
        <antcall target="jersey.build" />
    </target>

    <!--
        Checkout jersey source and build
    -->
    <target name="jersey.checkout" >
        <echo message="checkout jersey from ${jersey.svn.url}."/>
        <exec executable="svn" dir="${external.dir}" failonerror="true" >
	        <arg line="checkout" />
          <arg line="${jersey.svn.url}" />
          <arg line="jersey" />
	      </exec>
    </target>

    <target name="jersey.build" depends="jettison.build,jackson.build,jersey.checkout" >
        <!-- backup plugin-registry.xml file if it exists -->
        <delete failonerror="false" file="${external.dir}/jersey/plugin-registry.xml"/> 
        <copy failonerror="false" file="${maven.repo.local}/../plugin-registry.xml" todir="${external.dir}/jersey"/>
        <!-- and install a new one to make the jsr311-api build work -->
        <copy overwrite="true" file="${basedir}/jersey-extras/plugin-registry.xml" todir="${maven.repo.local}/.."/>
         <!-- build jersey -->
        <exec executable="mvn" dir="${external.dir}/jersey" failonerror="true" >
	        <arg line="-N" />
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jersey/jersey-core" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jersey/jersey-server" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jersey/jersey-client" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jersey/jersey-json" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jersey/jersey-atom" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jersey/jersey-fastinfoset" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
            <exec executable="mvn" dir="${external.dir}/jersey/jersey-bundle" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
           <exec executable="mvn" dir="${external.dir}/jersey/samples" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <arg line="-P-xsltproc" />
          <env key="JAVA_HOME" value="${JDK_1.5}" />
	      </exec>
          <exec executable="mvn" dir="${external.dir}/jersey/glassfish/v3-packages" failonerror="true" >
	        <arg line="-s ${basedir}/jersey-extras/jsr311-settings.xml" />
	        <arg line="-npu" />
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
                <!-- add project.scm.developerConnection and project.scm.connection properties -->
                <!-- since it's causing the build failure with the message:                    -->
                <!-- "java.lang.NullPointerException: The scm url cannot be null."             -->
                <!-- This is a maven bug.  See:  MOJO-1463 http://jira.codehaus.org/browse/MOJO-1463. -->
                <arg line="-Dproject.scm.developerConnection='scm:svn:https://jersey.dev.java.net/svn/jersey/trunk/jersey/'" /> 
                <arg line="-Dproject.scm.connection='scm:svn:https://jersey.dev.java.net/svn/jersey/trunk/jersey/'" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
          <env key="JAVA_HOME" value="${JDK_1.6}" />
        </exec>
	      <!-- restore original plugin-registry file -->
        <delete file="${maven.repo.local}/../plugin-registry.xml"/>
        <copy failonerror="false" file="${external.dir}/jsr311-api/plugin-registry.xml" todir="${maven.repo.local}/.."/>
    </target>

    <target name="jettison.checkout" >
        <echo message="checkout jettison from ${jettison.svn.url}."/>
        <exec executable="svn" dir="${external.dir}" failonerror="true" >
	        <arg line="checkout" />
          <arg line="${jettison.svn.url}" />
          <arg line="jettison" />
	      </exec>
    </target>

    <target name="jettison.build" depends="jettison.checkout" >
        <!-- build jettison -->
        <exec executable="mvn" dir="${external.dir}/jettison" failonerror="true" >
	        <arg line="-U" />
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
	        <arg line="-Dmaven.test.skip=true" />
          <arg line="install" />
	      </exec>
    </target>

    <target name="jackson.checkout" >
        <echo message="checkout jackson from ${jackson.svn.url}."/>
        <exec executable="svn" dir="${external.dir}" failonerror="true" >
	        <arg line="checkout" />
          <arg line="${jackson.svn.url}" />
          <arg line="jackson" />
	      </exec>
    </target>

    <target name="jackson.build" depends="jackson.checkout" >
        <!-- build jackson -->
        <exec executable="ant" dir="${external.dir}/jackson" failonerror="true" >
          <arg line="jars.asl" />
	      </exec>
        <exec executable="mvn" dir="${external.dir}/jackson" failonerror="true" >
	        <arg line="-Dmaven.repo.local=${maven.repo.local}" />
          <arg line="install:install-file" />
          <arg line="-Dfile=${external.dir}/jackson/build/jackson-core-asl-${jackson.version}.jar" />
          <arg line="-DpomFile=src/maven/jackson-core-asl.pom" />
          <arg line="-DlocalRepositoryPath=${maven.repo.local}" />
        </exec>
    </target>


</project>

